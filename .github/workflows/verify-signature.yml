name: Verify Signatures

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Sign Docs"]
    types:
      - completed

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Install dependencies -----------------------------------------------
      - name: Install GPG
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y gpg

      # --- Download build artifacts -------------------------------------------
      - name: Download signed artifacts
        uses: actions/download-artifact@v4
        with:
          name: pm-docs-signed
          path: docs/releases/

      # --- List downloaded files ----------------------------------------------
      - name: List downloaded files
        run: ls -l docs/releases/

      # --- Verify GPG signatures ----------------------------------------------
      - name: Verify signatures
        run: |
          pwsh -File scripts/sign-gpg.ps1 -TargetFile docs/releases/ChangeRequest.pdf -Verify
          pwsh -File scripts/sign-gpg.ps1 -TargetFile docs/releases/ImplementationPlan.pdf -Verify

      # --- Verify SHA256 hashes -----------------------------------------------
      - name: Verify hashes
        run: |
          pwsh -File scripts/verify-hash.ps1 -PdfFile docs/releases/ChangeRequest.pdf
          pwsh -File scripts/verify-hash.ps1 -PdfFile docs/releases/ImplementationPlan.pdf
